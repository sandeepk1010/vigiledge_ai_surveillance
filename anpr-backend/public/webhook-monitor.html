<!DOCTYPE html>
<html>
<head>
    <title>ANPR Webhook Monitor</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            margin: 0; 
            padding: 20px; 
            background: #0d1117; 
            color: #c9d1d9; 
        }
        .header {
            background: #161b22;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #30363d;
        }
        .status {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .status-card {
            flex: 1;
            background: #161b22;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #30363d;
        }
        .status-card h3 {
            margin: 0 0 10px 0;
            color: #58a6ff;
        }
        .status-value {
            font-size: 2em;
            font-weight: bold;
            color: #3fb950;
        }
        .log-container {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            height: 500px;
            overflow-y: auto;
            font-size: 13px;
        }
        .log-entry {
            padding: 10px;
            margin: 5px 0;
            background: #161b22;
            border-left: 3px solid #58a6ff;
            border-radius: 3px;
        }
        .log-entry.success {
            border-left-color: #3fb950;
        }
        .log-entry.error {
            border-left-color: #f85149;
        }
        .timestamp {
            color: #8b949e;
            font-size: 0.9em;
        }
        .plate {
            color: #ffa657;
            font-weight: bold;
            font-size: 1.2em;
        }
        h1 {
            color: #58a6ff;
            margin: 0;
        }
        .live-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #3fb950;
            border-radius: 50%;
            animation: pulse 2s infinite;
            margin-right: 10px;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .btn {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #2ea043;
        }
        .btn-secondary {
            background: #21262d;
            border: 1px solid #30363d;
        }
        .btn-secondary:hover {
            background: #30363d;
        }
        .instructions {
            background: #1f2937;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border-left: 4px solid #ffa657;
        }
        .code {
            background: #0d1117;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><span class="live-indicator"></span>ANPR Webhook Monitor</h1>
        <p>Monitoring: <code>http://192.168.1.120:5000/webhook</code> and <code>/webhooks</code></p>
    </div>

    <div class="status">
        <div class="status-card">
            <h3>Total Requests</h3>
            <div class="status-value" id="total-requests">0</div>
        </div>
        <div class="status-card">
            <h3>Last Detection</h3>
            <div class="status-value" id="last-plate" style="font-size: 1.5em;">Waiting...</div>
        </div>
        <div class="status-card">
            <h3>Detections/Min</h3>
            <div class="status-value" id="rate">0</div>
        </div>
    </div>

    <div class="instructions">
        <strong>‚ö†Ô∏è CAMERA NOT SENDING DATA?</strong><br><br>
        <strong>Configure your ANPR camera webhook to:</strong>
        <div class="code">
            URL: http://192.168.1.120:5000/webhook<br>
            Method: POST<br>
            Content-Type: application/json
        </div>
        <button class="btn" onclick="testWebhook()">üß™ Send Test Detection</button>
        <button class="btn btn-secondary" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
    </div>

    <h2>üìã Live Request Log</h2>
    <div class="log-container" id="log-container">
        <div style="text-align: center; padding: 50px; color: #8b949e;">
            <p>Waiting for webhook requests from camera...</p>
            <p style="font-size: 0.9em;">When a vehicle passes, you'll see the detection here.</p>
        </div>
    </div>

    <script>
        let totalRequests = 0;
        let lastMinuteRequests = [];
        let lastDetectionTime = 0;

        async function fetchLatestDetections() {
            try {
                const res = await fetch('http://localhost:5000/api/detections?page=1&limit=1');
                const data = await res.json();
                
                if (data.data && data.data.length > 0) {
                    const latest = data.data[0];
                    const detectionTime = new Date(latest.detected_at).getTime();
                    
                    // Only show if it's a new detection
                    if (detectionTime > lastDetectionTime) {
                        lastDetectionTime = detectionTime;
                        addLogEntry(latest);
                        updateStats(latest);
                    }
                }
            } catch (err) {
                console.error('Fetch error:', err);
            }
        }

        function addLogEntry(detection) {
            const container = document.getElementById('log-container');
            
            // Clear "waiting" message
            if (totalRequests === 0) {
                container.innerHTML = '';
            }
            
            const entry = document.createElement('div');
            entry.className = 'log-entry success';
            
            const timestamp = new Date(detection.detected_at).toLocaleString();
            const hasImages = detection.images && Object.keys(detection.images).length > 0;
            
            entry.innerHTML = `
                <div class="timestamp">${timestamp}</div>
                <div class="plate">${detection.plate}</div>
                <div>Camera: ${detection.camera} | ID: ${detection.id} | Images: ${hasImages ? '‚úÖ' : '‚ùå'}</div>
            `;
            
            container.insertBefore(entry, container.firstChild);
            
            // Keep only last 50 entries
            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        function updateStats(detection) {
            totalRequests++;
            document.getElementById('total-requests').textContent = totalRequests;
            document.getElementById('last-plate').textContent = detection.plate;
            
            // Update rate
            const now = Date.now();
            lastMinuteRequests.push(now);
            lastMinuteRequests = lastMinuteRequests.filter(t => now - t < 60000);
            document.getElementById('rate').textContent = lastMinuteRequests.length;
        }

        async function testWebhook() {
            const testPlate = 'TEST' + Math.floor(Math.random() * 10000);
            
            try {
                const res = await fetch('http://localhost:5000/webhook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        plateNumber: testPlate,
                        images: {
                            plate: 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+P+/HgAFhAJ/wlseKgAAAABJRU5ErkJggg==',
                            full: 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+P+/HgAFhAJ/wlseKgAAAABJRU5ErkJggg=='
                        }
                    })
                });
                
                if (res.ok) {
                    alert(`‚úÖ Test detection sent: ${testPlate}\n\nCheck the log below!`);
                } else {
                    alert('‚ùå Failed to send test detection');
                }
            } catch (err) {
                alert('‚ùå Error: ' + err.message);
            }
        }

        function clearLogs() {
            document.getElementById('log-container').innerHTML = `
                <div style="text-align: center; padding: 50px; color: #8b949e;">
                    <p>Logs cleared. Waiting for new detections...</p>
                </div>
            `;
            totalRequests = 0;
            lastMinuteRequests = [];
            document.getElementById('total-requests').textContent = '0';
            document.getElementById('rate').textContent = '0';
        }

        // Check for new detections every 2 seconds
        setInterval(fetchLatestDetections, 2000);
        
        // Initial load
        fetchLatestDetections();
    </script>
</body>
</html>
